<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• PantelMed - –ú–µ–¥–∏—á–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω–µ –º–µ–Ω—é */
        .navigation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-container {
            max-width: 500px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-decoration: none;
        }
        
        .nav-menu {
            display: flex;
            gap: 15px;
        }
        
        .nav-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .nav-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        .nav-button.active {
            background: rgba(255,255,255,0.3);
            border-color: white;
        }
        
        /* –ú–æ–±—ñ–ª—å–Ω–∞ –∞–¥–∞–ø—Ç–∞—Ü—ñ—è */
        @media (max-width: 480px) {
            .nav-container {
                flex-direction: column;
                gap: 10px;
                padding: 0 15px;
            }
            
            .nav-menu {
                width: 100%;
                justify-content: center;
            }
            
            .nav-button {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
        
        /* Telegram Login Widget —Å—Ç–∏–ª—ñ */
        .telegram-login-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            border-left: 4px solid #0088cc;
        }
        
        .telegram-user-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196F3;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω–µ –º–µ–Ω—é -->
    <nav class="navigation">
        <div class="nav-container">
            <a href="#" class="logo">üè• PantelMed</a>
            <div class="nav-menu">
                <a href="#" class="nav-button active" onclick="showSubscription()">
                    üíä –ü—ñ–¥–ø–∏—Å–∫–∞
                </a>
                <a href="shop.html" class="nav-button" onclick="showShop()">
                    üõí PantelMed Shop
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>üè• PantelMed</h1>
            <p>–†–æ–∑—à–∏—Ä–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –º–µ–¥–∏—á–Ω–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π</p>
        </div>
        
        <div class="content">
            <!-- Telegram Login Integration -->
            <div id="telegram-section" class="telegram-login-section">
                <h3>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Telegram</h3>
                <p>–£–≤—ñ–π–¥—ñ—Ç—å —á–µ—Ä–µ–∑ Telegram –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –¥–æ—Å–≤—ñ–¥—É</p>
                <div id="telegram-login-widget"></div>
                <div id="telegram-user-info" class="telegram-user-info" style="display: none;"></div>
            </div>
            
            <div class="user-info">
                <strong>üÜî –í–∞—à ID:</strong> <span class="user-id" id="userIdDisplay">–ì–µ–Ω–µ—Ä—É—î—Ç—å—Å—è...</span>
                <div style="margin-top: 8px; font-size: 12px; color: #666;">
                    –¶–µ–π ID –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —É –≤–∞—à–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø–ª–∞—Ç–µ–∂—ñ–≤
                </div>
            </div>
            
            <div id="statusCard" class="status-card">
                <div id="statusContent">üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤–∞—à —Å—Ç–∞—Ç—É—Å...</div>
            </div>
            
            <div id="paymentSection" style="display: none;">
                <div class="payment-section">
                    <h3>üí≥ –û–ø–ª–∞—Ç–∞ –ø—ñ–¥–ø–∏—Å–∫–∏</h3>
                    
                    <div class="amount-highlight">
                        <div>–°—É–º–∞ –¥–æ –æ–ø–ª–∞—Ç–∏:</div>
                        <div class="amount">2.6 USDT</div>
                        <div>TRC-20 Network</div>
                    </div>
                    
                    <div>
                        <strong>üí∞ –ê–¥—Ä–µ—Å–∞ –¥–ª—è –æ–ø–ª–∞—Ç–∏:</strong>
                        <div class="wallet-address">
                            TQeHa8VdwfyybxtioW4ggbnDC1rbWe8nFa
                            <button class="copy-btn" onclick="copyWallet()">üìã</button>
                        </div>
                    </div>
                    
                    <div class="steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div>–°–∫–æ–ø—ñ—é–π—Ç–µ –∞–¥—Ä–µ—Å—É –≥–∞–º–∞–Ω—Ü—è –≤–∏—â–µ</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div>–ù–∞–¥—ñ—à–ª—ñ—Ç—å 2.6 USDT (TRC-20) –Ω–∞ —Ü—é –∞–¥—Ä–µ—Å—É</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–Ø –æ–ø–ª–∞—Ç–∏–≤" –ø—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</div>
                        </div>
                    </div>
                    
                    <button id="checkPaymentBtn" class="btn-primary" onclick="checkPayment()">
                        ‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–≤
                    </button>
                </div>
            </div>
            
            <div id="premiumContent" class="premium-content">
                <h3>üéâ –î–æ—Å—Ç—É–ø –≤—ñ–¥–∫—Ä–∏—Ç–æ!</h3>
                <div id="subscriptionInfo" class="subscription-info"></div>
                <ul>
                    <li>üìÑ <strong>–°—Ç–µ–∫ –¥–æ–±–∞–≤–æ–∫:</strong> –¶–∏–Ω–∫, –ú–∞–≥–Ω—ñ–π, –û–º–µ–≥–∞-3, –í—ñ—Ç–∞–º—ñ–Ω D3</li>
                    <li>üß™ <strong>–°–ø–∏—Å–æ–∫ –∞–Ω–∞–ª—ñ–∑—ñ–≤:</strong> –¢–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω, TSH, –í—ñ—Ç–∞–º—ñ–Ω D, B12</li>
                    <li>üé• <strong>–í—ñ–¥–µ–æ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏:</strong> –Ü–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü—ñ—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</li>
                    <li>üß† <strong>AI –Ü–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä:</strong> –ê–Ω–∞–ª—ñ–∑ –≤–∞—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</li>
                </ul>
                
                <button onclick="downloadContent()" class="btn-primary">
                    üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏
                </button>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = window.location.origin;
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
        let currentTelegramUser = null;
        let userId = null;

        // Telegram Web App —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        function initTelegramWebApp() {
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                
                // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const telegramUser = tg.initDataUnsafe.user;
                    handleTelegramLogin(telegramUser, 'webapp');
                }
            }
        }

        // Telegram Login Widget
        function initTelegramLoginWidget() {
            const script = document.createElement('script');
            script.async = true;
            script.src = 'https://telegram.org/js/telegram-widget.js?22';
            script.setAttribute('data-telegram-login', 'pantelmed_bot');
            script.setAttribute('data-size', 'large');
            script.setAttribute('data-radius', '10');
            script.setAttribute('data-onauth', 'onTelegramAuth(user)');
            script.setAttribute('data-request-access', 'write');
            
            document.getElementById('telegram-login-widget').appendChild(script);
        }

        // –û–±—Ä–æ–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ Telegram
        function onTelegramAuth(user) {
            handleTelegramLogin(user, 'widget');
        }

        async function handleTelegramLogin(telegramUser, source) {
            try {
                currentTelegramUser = telegramUser;
                
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–∞–Ω—ñ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch(`${API_BASE}/api/telegram-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegram_user: telegramUser,
                        source: source
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    userId = result.user_id;
                    showTelegramUserInfo(telegramUser);
                    document.getElementById('userIdDisplay').textContent = userId;
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å –ø—ñ–¥–ø–∏—Å–∫–∏
                    checkSubscriptionStatus();
                } else {
                    console.error('Telegram login failed:', result.error);
                }
            } catch (error) {
                console.error('Telegram login error:', error);
            }
        }

        function showTelegramUserInfo(user) {
            const userInfoDiv = document.getElementById('telegram-user-info');
            userInfoDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center;">
                    ${user.photo_url ? `<img src="${user.photo_url}" class="user-avatar" alt="Avatar">` : 'üë§'}
                    <div>
                        <strong>üéâ –í—ñ—Ç–∞—î–º–æ, ${user.first_name}!</strong><br>
                        <small>@${user.username || 'no_username'} | Telegram ID: ${user.id}</small>
                    </div>
                </div>
            `;
            userInfoDiv.style.display = 'block';
            
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ login widget
            document.getElementById('telegram-login-widget').style.display = 'none';
        }

        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (–∑ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥—É)
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getUserId() {
            if (userId) return userId;
            
            let storedUserId = localStorage.getItem('pantelmed_user_id');
            if (!storedUserId) {
                storedUserId = generateUserId();
                localStorage.setItem('pantelmed_user_id', storedUserId);
                console.log('–°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤–∏–π User ID:', storedUserId);
            }
            userId = storedUserId;
            return storedUserId;
        }

        // –ï–ª–µ–º–µ–Ω—Ç–∏ DOM
        const statusCard = document.getElementById('statusCard');
        const statusContent = document.getElementById('statusContent');
        const paymentSection = document.getElementById('paymentSection');
        const premiumContent = document.getElementById('premiumContent');
        const checkPaymentBtn = document.getElementById('checkPaymentBtn');
        const subscriptionInfo = document.getElementById('subscriptionInfo');

        function showStatus(message, type = 'info') {
            statusCard.className = `status-card ${type}`;
            statusContent.innerHTML = message;
        }

        function copyWallet() {
            const walletAddress = "TQeHa8VdwfyybxtioW4ggbnDC1rbWe8nFa";
            navigator.clipboard.writeText(walletAddress).then(() => {
                showStatus("üìã –ê–¥—Ä–µ—Å—É –≥–∞–º–∞–Ω—Ü—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!", "success");
                setTimeout(() => checkSubscriptionStatus(), 2000);
            }).catch(() => {
                alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∞–¥—Ä–µ—Å—É");
            });
        }

        async function checkSubscriptionStatus() {
            const currentUserId = getUserId();
            try {
                const response = await fetch(`${API_BASE}/subscription-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: currentUserId })
                });

                const data = await response.json();

                if (data.has_subscription && data.active) {
                    showStatus("‚úÖ –£ –≤–∞—Å —î –∞–∫—Ç–∏–≤–Ω–∞ –ø—ñ–¥–ø–∏—Å–∫–∞!", 'success');
                    subscriptionInfo.innerHTML = `
                        <strong>üìÖ –ê–∫—Ç–∏–≤–Ω–∞ –¥–æ:</strong> ${new Date(data.expires_at).toLocaleDateString('uk-UA')}<br>
                        <strong>‚è∞ –ó–∞–ª–∏—à–∏–ª–æ—Å—å:</strong> ${data.days_left} –¥–Ω—ñ–≤
                    `;
                    premiumContent.classList.add('show');
                    paymentSection.style.display = 'none';
                } else {
                    showStatus("üîí –î–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –ø—Ä–µ–º—ñ—É–º —Ñ—É–Ω–∫—Ü—ñ–π –ø–æ—Ç—Ä—ñ–±–Ω–∞ –ø—ñ–¥–ø–∏—Å–∫–∞", 'warning');
                    paymentSection.style.display = 'block';
                    premiumContent.classList.remove('show');
                }
            } catch (error) {
                console.error('Error checking subscription:', error);
                showStatus("‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–∫–∞–∑—É—î–º–æ —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç–∏.", 'error');
                paymentSection.style.display = 'block';
            }
        }

        async function checkPayment() {
            const currentUserId = getUserId();
            checkPaymentBtn.disabled = true;
            checkPaymentBtn.innerHTML = '<span class="loading"></span> –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–ª–∞—Ç—ñ–∂...';

            try {
                const response = await fetch(`${API_BASE}/check-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: currentUserId })
                });

                const data = await response.json();

                if (data.access === "granted") {
                    showStatus("üéâ –ü–ª–∞—Ç—ñ–∂ –∑–Ω–∞–π–¥–µ–Ω–æ! –ü—ñ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞", 'success');
                    
                    if (data.subscription) {
                        subscriptionInfo.innerHTML = `
                            <strong>üìÖ –ê–∫—Ç–∏–≤–Ω–∞ –¥–æ:</strong> ${new Date(data.subscription.expires_at).toLocaleDateString('uk-UA')}<br>
                            <strong>‚è∞ –ó–∞–ª–∏—à–∏–ª–æ—Å—å:</strong> ${data.subscription.days_left} –¥–Ω—ñ–≤<br>
                            <strong>üí∞ –°—É–º–∞ –ø–ª–∞—Ç–µ–∂—É:</strong> ${data.transaction?.amount || '2.6'} USDT
                        `;
                    }
                    
                    premiumContent.classList.add('show');
                    paymentSection.style.display = 'none';
                } else {
                    showStatus(`‚ùå ${data.message || '–ü–ª–∞—Ç—ñ–∂ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π. –°–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω.'}`, 'warning');
                    checkPaymentBtn.disabled = false;
                    checkPaymentBtn.innerHTML = "‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–≤";
                }
            } catch (error) {
                console.error('Payment check error:', error);
                showStatus("‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ –ø–ª–∞—Ç–µ–∂—É", 'error');
                checkPaymentBtn.disabled = false;
                checkPaymentBtn.innerHTML = "‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–≤";
            }
        }

        function downloadContent() {
            alert("üöÄ –§—É–Ω–∫—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—É–¥–µ –¥–æ–¥–∞–Ω–∞ –≤ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ!");
        }

        // –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        function showSubscription() {
            // –ü–æ—Ç–æ—á–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ (–ø—ñ–¥–ø–∏—Å–∫–∞)
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.nav-button[onclick="showSubscription()"]').classList.add('active');
        }

        function showShop() {
            // –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –º–∞–≥–∞–∑–∏–Ω—É
            window.location.href = 'shop.html';
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('PantelMed —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
            
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ User ID
            const currentUserId = getUserId();
            document.getElementById('userIdDisplay').textContent = currentUserId;
            
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ Telegram
            initTelegramWebApp();
            
            // –Ø–∫—â–æ –Ω–µ–º–∞—î WebApp, –ø–æ–∫–∞–∑—É—î–º–æ Login Widget
            setTimeout(() => {
                if (!currentTelegramUser) {
                    initTelegramLoginWidget();
                }
            }, 1000);
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å –ø—ñ–¥–ø–∏—Å–∫–∏
            checkSubscriptionStatus();
        });

        // –ü–µ—Ä—ñ–æ–¥–∏—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É
        setInterval(() => {
            if (document.visibilityState === 'visible' && paymentSection.style.display !== 'none') {
                console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É...');
                checkSubscriptionStatus();
            }
        }, 30000);

        // –û–±—Ä–æ–±–∫–∞ URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ (–∑ Telegram –±–æ—Ç–∞)
        const urlParams = new URLSearchParams(window.location.search);
        const telegramUserId = urlParams.get('user_id');
        const source = urlParams.get('source');

        if (telegramUserId && source === 'telegram') {
            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Å–µ—Ä–≤–µ—Ä–∞
            fetch(`${API_BASE}/api/telegram-user/${telegramUserId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.telegram_id) {
                        handleTelegramLogin({
                            id: data.telegram_id,
                            first_name: data.first_name,
                            last_name: data.last_name,
                            username: data.username,
                            photo_url: data.photo_url
                        }, 'bot_redirect');
                    }
                })
                .catch(error => console.log('Bot redirect user not found'));
        }
    </script>
</body>
</html>
