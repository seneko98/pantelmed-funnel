<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí≥ –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è - PantelMed</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω–µ –º–µ–Ω—é */
        .navigation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-container {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-decoration: none;
        }
        
        .nav-menu {
            display: flex;
            gap: 15px;
        }
        
        .nav-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .nav-button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è checkout */
        .checkout-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .checkout-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .order-type-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .badge-subscription {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-supplements {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .order-summary {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .summary-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 18px;
            color: #4CAF50;
        }
        
        .item-details {
            flex-grow: 1;
        }
        
        .item-name {
            font-weight: bold;
            color: #333;
        }
        
        .item-description {
            font-size: 14px;
            color: #666;
        }
        
        .payment-methods {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .payment-method {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-method:hover {
            border-color: #4CAF50;
            background: #f8f9fa;
        }
        
        .payment-method.selected {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .payment-method-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .payment-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        
        .payment-title {
            font-weight: bold;
            font-size: 16px;
        }
        
        .payment-description {
            color: #666;
            font-size: 14px;
            margin-left: 39px;
        }
        
        .crypto-payment-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }
        
        .wallet-address-section {
            background: #e8f5e9;
            border: 2px dashed #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
            margin: 10px 0;
            background: white;
            padding: 10px;
            border-radius: 5px;
        }
        
        .copy-address-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        .customer-info-form {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        
        .checkout-actions {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .total-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .total-amount {
            font-size: 28px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .total-crypto {
            color: #666;
            margin-top: 5px;
        }
        
        .checkout-btn-container {
            display: flex;
            gap: 15px;
        }
        
        .btn-back {
            background: #6c757d;
            color: white;
            flex: 1;
        }
        
        .btn-continue {
            background: #4CAF50;
            color: white;
            flex: 2;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .payment-steps {
            background: #fff3e0;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .step-number {
            background: #ff9800;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        /* –ú–æ–±—ñ–ª—å–Ω–∞ –∞–¥–∞–ø—Ç–∞—Ü—ñ—è */
        @media (max-width: 768px) {
            .checkout-container {
                padding: 15px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .checkout-btn-container {
                flex-direction: column;
            }
            
            .nav-container {
                flex-direction: column;
                gap: 10px;
                padding: 0 15px;
            }
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω–µ –º–µ–Ω—é -->
    <nav class="navigation">
        <div class="nav-container">
            <a href="index.html" class="logo">üè• PantelMed</a>
            <div class="nav-menu">
                <a href="index.html" class="nav-button">üíä –ü—ñ–¥–ø–∏—Å–∫–∞</a>
                <a href="shop.html" class="nav-button">üõí Shop</a>
            </div>
        </div>
    </nav>

    <div class="checkout-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="checkout-header">
            <div id="order-type-badge" class="order-type-badge">
                <!-- –ë—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ JavaScript -->
            </div>
            <h1>üí≥ –û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>
            <p id="checkout-description">–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –¥–µ—Ç–∞–ª—ñ —Ç–∞ –æ–±–µ—Ä—ñ—Ç—å —Å–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏</p>
        </div>

        <!-- –†–µ–∑—é–º–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
        <div class="order-summary">
            <h3>üìã –í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
            <div id="order-items">
                <!-- –ë—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ JavaScript -->
            </div>
        </div>

        <!-- –°–ø–æ—Å–æ–±–∏ –æ–ø–ª–∞—Ç–∏ -->
        <div class="payment-methods">
            <h3>üí≥ –°–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏</h3>
            
            <!-- –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ -->
            <div class="payment-method" id="crypto-method" onclick="selectPaymentMethod('crypto')">
                <div class="payment-method-header">
                    <div class="payment-icon">‚Çø</div>
                    <div>
                        <div class="payment-title">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ (USDT)</div>
                        <div class="payment-description">–ú–∏—Ç—Ç—î–≤–∞ –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ TRC-20 –º–µ—Ä–µ–∂—É</div>
                    </div>
                </div>
                
                <div class="crypto-payment-details" id="crypto-details">
                    <div class="wallet-address-section">
                        <strong>üí∞ –ê–¥—Ä–µ—Å–∞ –¥–ª—è –æ–ø–ª–∞—Ç–∏:</strong>
                        <div class="wallet-address" id="wallet-address">TQeHa8VdwfyybxtioW4ggbnDC1rbWe8nFa</div>
                        <button class="copy-address-btn" onclick="copyWalletAddress()">üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∞–¥—Ä–µ—Å—É</button>
                    </div>
                    
                    <div class="payment-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div>–°–∫–æ–ø—ñ—é–π—Ç–µ –∞–¥—Ä–µ—Å—É –≥–∞–º–∞–Ω—Ü—è</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div>–ù–∞–¥—ñ—à–ª—ñ—Ç—å USDT —á–µ—Ä–µ–∑ TRC-20 –º–µ—Ä–µ–∂—É</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–ª–∞—Ç—ñ–∂</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –ë–ê–î—ñ–≤) -->
            <div class="payment-method" id="cod-method" onclick="selectPaymentMethod('cod')" style="display: none;">
                <div class="payment-method-header">
                    <div class="payment-icon">üì¶</div>
                    <div>
                        <div class="payment-title">–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ</div>
                        <div class="payment-description">–°–ø–ª–∞—á—É–π—Ç–µ –≥–æ—Ç—ñ–≤–∫–æ—é –∞–±–æ –∫–∞—Ä—Ç–∫–æ—é –≤ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—ñ –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞ (–¥–ª—è –ë–ê–î—ñ–≤) -->
        <div class="customer-info-form" id="customer-info-form">
            <h3>üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>
            
            <form id="checkout-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–Ü–º'—è *</label>
                        <input type="text" class="form-input" id="first-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü—Ä—ñ–∑–≤–∏—â–µ *</label>
                        <input type="text" class="form-input" id="last-name" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìû –¢–µ–ª–µ—Ñ–æ–Ω *</label>
                    <input type="tel" class="form-input" id="phone" placeholder="+380XXXXXXXXX" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">üèôÔ∏è –ú—ñ—Å—Ç–æ *</label>
                        <select class="form-select" id="city" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</option>
                            <option value="kyiv">–ö–∏—ó–≤</option>
                            <option value="lviv">–õ—å–≤—ñ–≤</option>
                            <option value="odesa">–û–¥–µ—Å–∞</option>
                            <option value="kharkiv">–•–∞—Ä–∫—ñ–≤</option>
                            <option value="dnipro">–î–Ω—ñ–ø—Ä–æ</option>
                            <option value="zaporizhzhia">–ó–∞–ø–æ—Ä—ñ–∂–∂—è</option>
                            <option value="other">–Ü–Ω—à–µ –º—ñ—Å—Ç–æ</option>
                        </select>
                    </div>
                    <div class="form-group" id="other-city-group" style="display: none;">
                        <label class="form-label">–ù–∞–∑–≤–∞ –º—ñ—Å—Ç–∞</label>
                        <input type="text" class="form-input" id="other-city">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üì¶ –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏ *</label>
                    <input type="text" class="form-input" id="warehouse" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ1" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üí≠ –ö–æ–º–µ–Ω—Ç–∞—Ä</label>
                    <textarea class="form-input" id="comment" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ–±–∞–∂–∞–Ω–Ω—è"></textarea>
                </div>
            </form>
        </div>

        <!-- –î—ñ—ó -->
        <div class="checkout-actions">
            <div class="total-section">
                <div class="total-amount" id="total-amount">$0.00</div>
                <div class="total-crypto" id="total-crypto">0 USDT</div>
            </div>
            
            <div class="checkout-btn-container">
                <button class="btn btn-back" onclick="goBack()">
                    ‚óÄÔ∏è –ù–∞–∑–∞–¥
                </button>
                <button class="btn-submit" id="submit-btn" onclick="processOrder()">
                    üöÄ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
                </button>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
        const API_BASE = window.location.origin;
        let orderData = null;
        let orderType = null; // 'subscription' –∞–±–æ 'supplements'
        let selectedPaymentMethod = null;
        let currentTelegramUser = null;
        let userId = null;

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        document.addEventListener('DOMContentLoaded', function() {
            initializeCheckout();
            setupEventListeners();
        });

        function initializeCheckout() {
            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ URL –∞–±–æ localStorage
            parseOrderData();
            
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ Telegram
            initTelegramIntegration();
            
            // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
            displayOrderSummary();
            
            // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ —Ñ–æ—Ä–º—É –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É
            setupPaymentMethods();
            
            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –¥–∞–Ω—ñ –∑ Telegram
            fillTelegramUserData();
        }

        function parseOrderData() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç–∏–ø –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
            orderType = urlParams.get('type') || 'subscription';
            
            if (orderType === 'supplements') {
                // –î–∞–Ω—ñ –∑ –º–∞–≥–∞–∑–∏–Ω—É –ë–ê–î—ñ–≤
                const cartData = localStorage.getItem('cart_data');
                if (cartData) {
                    orderData = JSON.parse(cartData);
                } else {
                    // –¢–µ—Å—Ç–æ–≤—ñ –¥–∞–Ω—ñ
                    orderData = {
                        items: [
                            { name: '–û–º–µ–≥–∞-3 –ü—Ä–µ–º—ñ—É–º', emoji: 'üêü', quantity: 1, price: 2.6 }
                        ],
                        total: 2.6
                    };
                }
            } else {
                // –ü—ñ–¥–ø–∏—Å–∫–∞
                orderData = {
                    type: 'subscription',
                    name: '–ú–µ–¥–∏—á–Ω–∞ –ø—ñ–¥–ø–∏—Å–∫–∞ PantelMed',
                    description: '–î–æ—Å—Ç—É–ø –¥–æ –ø—Ä–µ–º—ñ—É–º –∫–æ–Ω—Ç–µ–Ω—Ç—É –Ω–∞ 30 –¥–Ω—ñ–≤',
                    price: 2.6,
                    duration: '30 –¥–Ω—ñ–≤'
                };
            }
            
            // –û—Ç—Ä–∏–º—É—î–º–æ User ID
            userId = getUserId();
        }

        function getUserId() {
            let storedUserId = localStorage.getItem('pantelmed_user_id');
            if (!storedUserId) {
                storedUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('pantelmed_user_id', storedUserId);
            }
            return storedUserId;
        }

        function initTelegramIntegration() {
            // Telegram WebApp
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    currentTelegramUser = tg.initDataUnsafe.user;
                }
            }
            
            // URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
            const urlParams = new URLSearchParams(window.location.search);
            const telegramUserId = urlParams.get('user_id');
            
            if (telegramUserId) {
                fetchTelegramUser(telegramUserId);
            }
        }

        async function fetchTelegramUser(telegramUserId) {
            try {
                const response = await fetch(`${API_BASE}/api/telegram-user/${telegramUserId}`);
                if (response.ok) {
                    const userData = await response.json();
                    currentTelegramUser = {
                        id: userData.telegram_id,
                        first_name: userData.first_name,
                        last_name: userData.last_name,
                        username: userData.username
                    };
                    fillTelegramUserData();
                }
            } catch (error) {
                console.log('Telegram user not found:', error);
            }
        }

        function fillTelegramUserData() {
            if (currentTelegramUser) {
                const firstNameInput = document.getElementById('first-name');
                const lastNameInput = document.getElementById('last-name');
                
                if (firstNameInput && currentTelegramUser.first_name) {
                    firstNameInput.value = currentTelegramUser.first_name;
                }
                if (lastNameInput && currentTelegramUser.last_name) {
                    lastNameInput.value = currentTelegramUser.last_name;
                }
            }
        }

        function displayOrderSummary() {
            const orderTypeBadge = document.getElementById('order-type-badge');
            const orderItems = document.getElementById('order-items');
            const totalAmount = document.getElementById('total-amount');
            const totalCrypto = document.getElementById('total-crypto');
            
            let total = 0;
            let itemsHTML = '';
            
            if (orderType === 'supplements') {
                orderTypeBadge.className = 'order-type-badge badge-supplements';
                orderTypebadge.textContent = 'üõí –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ë–ê–î—ñ–≤';
                
                orderData.items.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    
                    itemsHTML += `
                        <div class="summary-item">
                            <div class="item-details">
                                <div class="item-name">${item.emoji || 'üíä'} ${item.name}</div>
                                <div class="item-description">–ö—ñ–ª—å–∫—ñ—Å—Ç—å: ${item.quantity}</div>
                            </div>
                            <div>$${itemTotal.toFixed(2)}</div>
                        </div>
                    `;
                });
            } else {
                orderTypeBadge.className = 'order-type-badge badge-subscription';
                orderTypeBadge.textContent = 'üíä –ú–µ–¥–∏—á–Ω–∞ –ø—ñ–¥–ø–∏—Å–∫–∞';
                
                total = orderData.price;
                itemsHTML = `
                    <div class="summary-item">
                        <div class="item-details">
                            <div class="item-name">üíä ${orderData.name}</div>
                            <div class="item-description">${orderData.description}</div>
                        </div>
                        <div>$${orderData.price.toFixed(2)}</div>
                    </div>
                `;
            }
            
            itemsHTML += `
                <div class="summary-item">
                    <div><strong>–ó–∞–≥–∞–ª–æ–º:</strong></div>
                    <div><strong>$${total.toFixed(2)}</strong></div>
                </div>
            `;
            
            orderItems.innerHTML = itemsHTML;
            totalAmount.textContent = `$${total.toFixed(2)}`;
            totalCrypto.textContent = `${total.toFixed(1)} USDT`;
        }

        function setupPaymentMethods() {
            const codMethod = document.getElementById('cod-method');
            const customerForm = document.getElementById('customer-info-form');
            
            if (orderType === 'supplements') {
                // –ü–æ–∫–∞–∑—É—î–º–æ –æ–ø–ª–∞—Ç—É –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –¥–ª—è –ë–ê–î—ñ–≤
                codMethod.style.display = 'block';
                selectPaymentMethod('cod'); // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
            } else {
                // –¢—ñ–ª—å–∫–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ –¥–ª—è –ø—ñ–¥–ø–∏—Å–∫–∏
                selectPaymentMethod('crypto');
            }
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // –°–∫–∏–¥–∞—î–º–æ –≤–∏–±—ñ—Ä
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –¥–µ—Ç–∞–ª—ñ
            document.getElementById('crypto-details').style.display = 'none';
            document.getElementById('customer-info-form').style.display = 'none';
            
            if (method === 'crypto') {
                document.getElementById('crypto-method').classList.add('selected');
                document.getElementById('crypto-details').style.display = 'block';
                
                if (orderType === 'supplements') {
                    document.getElementById('customer-info-form').style.display = 'block';
                }
                
                updateSubmitButton('–û–ø–ª–∞—Ç–∏—Ç–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ—é');
                
            } else if (method === 'cod') {
                document.getElementById('cod-method').classList.add('selected');
                document.getElementById('customer-info-form').style.display = 'block';
                
                updateSubmitButton('–û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è');
            }
        }

        function updateSubmitButton(text) {
            document.getElementById('submit-btn').textContent = text;
        }

        function setupEventListeners() {
            // –û–±—Ä–æ–±–∫–∞ –∑–º—ñ–Ω–∏ –º—ñ—Å—Ç–∞
            document.getElementById('city').addEventListener('change', function() {
                const otherCityGroup = document.getElementById('other-city-group');
                if (this.value === 'other') {
                    otherCityGroup.style.display = 'block';
                    document.getElementById('other-city').required = true;
                } else {
                    otherCityGroup.style.display = 'none';
                    document.getElementById('other-city').required = false;
                }
            });
        }

        function copyWalletAddress() {
            const address = document.getElementById('wallet-address').textContent;
            navigator.clipboard.writeText(address).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!';
                btn.style.background = '#4CAF50';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        }

        async function processOrder() {
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span> –û–±—Ä–æ–±–∫–∞...';

            try {
                if (selectedPaymentMethod === 'crypto') {
                    await processCryptoPayment();
                } else if (selectedPaymentMethod === 'cod') {
                    await processCODOrder();
                }
            } catch (error) {
                console.error('Order processing error:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = selectedPaymentMethod === 'crypto' ? 
                    '–û–ø–ª–∞—Ç–∏—Ç–∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ—é' : '–û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è';
            }
        }

        async function processCryptoPayment() {
            if (orderType === 'subscription') {
                // –ü—ñ–¥–ø–∏—Å–∫–∞ - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è
                window.location.href = `index.html?auto_payment=true&user_id=${userId}`;
            } else {
                // –ë–ê–î–∏ –∑ –∫—Ä–∏–ø—Ç–æ–æ–ø–ª–∞—Ç–æ—é - –ø–æ–∫–∏ —â–æ —Ñ—É–Ω–∫—Ü—ñ—è –Ω–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞
                alert('üí° –ö—Ä–∏–ø—Ç–æ–æ–ø–ª–∞—Ç–∞ –¥–ª—è –ë–ê–î—ñ–≤ –±—É–¥–µ –¥–æ–¥–∞–Ω–∞ –≤ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ. –û–±–µ—Ä—ñ—Ç—å "–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ".');
            }
        }

        async function processCODOrder() {
            // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ñ–æ—Ä–º–∏
            const form = document.getElementById('checkout-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // –ó–±–∏—Ä–∞—î–º–æ –¥–∞–Ω—ñ
            const city = document.getElementById('city').value;
            const orderRequestData = {
                user_id: userId,
                telegram_user: currentTelegramUser,
                items: orderData.items,
                total_amount: orderData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                order_info: {
                    first_name: document.getElementById('first-name').value,
                    last_name: document.getElementById('last-name').value,
                    phone: document.getElementById('phone').value,
                    city: city === 'other' ? document.getElementById('other-city').value : city,
                    warehouse: document.getElementById('warehouse').value,
                    comment: document.getElementById('comment').value
                },
                payment_method: 'cash_on_delivery',
                source: 'checkout'
            };

            // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
            const response = await fetch(`${API_BASE}/api/create-order`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderRequestData)
            });

            const result = await response.json();

            if (result.status === 'created') {
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
                await sendOrderNotification(orderRequestData);
                
                // –û—á–∏—â–∞—î–º–æ –∫–æ—à–∏–∫
                localStorage.removeItem('cart_data');
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ
                window.location.href = `thankyou_supplements.html?order_id=${result.order_id}`;
            } else {
                throw new Error(result.error || '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è');
            }
        }

        async function sendOrderNotification(orderData) {
            try {
                await fetch(`${API_BASE}/api/order-notification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order: orderData })
                });
            } catch (error) {
                console.error('Notification error:', error);
            }
        }

        function goBack() {
            if (orderType === 'supplements') {
                window.location.href = 'shop.html';
            } else {
                window.location.href = 'index.html';
            }
        }

        // –î–æ–¥–∞—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–Ω—ñ–º–∞—Ü—ñ—é
        const loadingStyle = `
            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid #4CAF50;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = loadingStyle;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
